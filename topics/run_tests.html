<!-- Empty override file take the place of env/lib/python3.8/site-packages/sphinx_rtd_theme/breadcrumbs.html, which generates the top nav breadcrumbs. -->

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Suite for Prechecking Runs &mdash; Bay-Delta SCHISM</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=ca842793"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Common Problems and Diagnosis" href="problems.html" />
    <link rel="prev" title="Checklists" href="checklists.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo6.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Bay-Delta SCHISM Project</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getmodel.html">Installation And Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#schism-code-or-binaries">SCHISM Code or Binaries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#downloading">Downloading</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#compile-settings">Compile Settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#git">Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#bay-delta-package">Bay-Delta Package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#required-python-packages">Required Python Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#configuration-system">Configuration System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#id5">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#configuration-sources">Configuration Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#example-configuration-file">Example Configuration File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#overriding-configuration">Overriding Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#bathymetry">Bathymetry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#complete-sample-inputs">Complete Sample Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#visit-schism-plug-in">VisIt SCHISM Plug-in</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getmodel.html#links-to-tools">Links to tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../learning.html">Learning Resources for Bay-Delta SCHISM</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../learning.html#general-resources-and-tools">General Resources and Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learning.html#manuals">Manuals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learning.html#getting-help">Getting Help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../learning.html#vims-and-other-external-resources">VIMS and Other External Resources</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_guide.html">Bay-Delta SCHISM User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../user_guide.html#bay-delta-schism-setup">Bay-Delta SCHISM Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getmodel.html">Getting the Tools and Setting Up</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#schism-code-or-binaries">SCHISM Code or Binaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#git">Git</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#bay-delta-package">Bay-Delta Package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#required-python-packages">Required Python Packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#configuration-system">Configuration System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#bathymetry">Bathymetry</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#complete-sample-inputs">Complete Sample Inputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#visit-schism-plug-in">VisIt SCHISM Plug-in</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getmodel.html#links-to-tools">Links to tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="processed_run.html">Running a Preprepared Setup</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="../user_guide.html#bay-delta-schism-essentials">Bay-Delta SCHISM Essentials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../user_guide.html#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview of a Bay-Delta SCHISM Run</a></li>
<li class="toctree-l4"><a class="reference internal" href="vignette.html">Vignette: Hindcast Bay Delta SCHISM at Delta Modeling Section with Preprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="files_and_directories.html">Required Files, Directory Structure and Recommended Study Practices</a></li>
<li class="toctree-l4"><a class="reference internal" href="preprocess.html">Grid, Spatial Data and Preprocessor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../user_guide.html#boundaries-input-files">Boundaries &amp; Input Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="ocean.html">Prepare Ocean Boundary (elev2D.th.nc)</a></li>
<li class="toctree-l4"><a class="reference internal" href="flow_boundary.html">Inflow/Outflow Boundaries</a></li>
<li class="toctree-l4"><a class="reference internal" href="atmospheric.html">Atmospheric setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="barotropic.html">Ocean Boundary Stabilization: Barotropic Warmup</a></li>
<li class="toctree-l4"><a class="reference internal" href="param.html">Key Run Parameters and Gotchas</a></li>
<li class="toctree-l4"><a class="reference internal" href="hotstart.html">Run Initialization and Restart (Hotstart)</a></li>
<li class="toctree-l4"><a class="reference internal" href="nudging.html">Nudging Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="vegetation.html">Vegetation</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="reference internal" href="../user_guide.html#inspection-of-model-setup">Inspection of Model Setup</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="checklists.html">Checklists</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Test Suite for Prechecking Runs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../user_guide.html#output-files">Output Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide.html#advanced-tasks-and-concepts">Advanced Tasks and Concepts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="problems.html">Common Problems and Diagnosis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="problems.html#where-does-schism-write-error-messages">Where does SCHISM write error messages?</a></li>
<li class="toctree-l4"><a class="reference internal" href="problems.html#my-run-says-segfault">My run says “segfault”</a></li>
<li class="toctree-l4"><a class="reference internal" href="problems.html#the-runs-seems-very-slow-compared-to-normal">The runs seems very slow compared to normal</a></li>
<li class="toctree-l4"><a class="reference internal" href="problems.html#dry-boundary">Dry boundary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="age.html">Simulating water age</a><ul>
<li class="toctree-l4"><a class="reference internal" href="age.html#compile-with-age">Compile with age</a></li>
<li class="toctree-l4"><a class="reference internal" href="age.html#parameters-in-param-nml">Parameters in param.nml</a></li>
<li class="toctree-l4"><a class="reference internal" href="age.html#additional-ic-files">Additional *.ic files</a></li>
<li class="toctree-l4"><a class="reference internal" href="age.html#hotstart-considerations">Hotstart considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="age.html#typical-output-processing">Typical output processing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="sea_level_rise.html">Sea Level Rise</a></li>
<li class="toctree-l3"><a class="reference internal" href="sources.html">Sources, Sinks, Delta Channel Depletions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="sources.html#identifying-source-locations-and-names-in-preprocessor">Identifying source locations and names in preprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="sources.html#delta-and-suisun-channel-depletions">Delta and Suisun channel depletions</a></li>
<li class="toctree-l4"><a class="reference internal" href="sources.html#making-sure-you-includ-the-th-files-for-sources-sinks">Making sure you includ the th files for sources/sinks</a></li>
<li class="toctree-l4"><a class="reference internal" href="sources.html#tracer-concentrations">Tracer concentrations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="structures.html">Hydraulic Structures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="structures.html#where-is-the-documentation">Where is the documentation?</a></li>
<li class="toctree-l4"><a class="reference internal" href="structures.html#setting-up-the-mesh-to-make-structures-easy">Setting up the mesh to make structures easy</a></li>
<li class="toctree-l4"><a class="reference internal" href="structures.html#preventing-dry-boundary-messages">Preventing dry boundary messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="structures.html#important-bay-delta-examples">Important Bay-Delta examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="mesh.html">Gridding the Horizontal Mesh</a><ul>
<li class="toctree-l4"><a class="reference internal" href="mesh.html#meshing">Meshing</a></li>
<li class="toctree-l4"><a class="reference internal" href="mesh.html#vertical-mesh-setup">Vertical mesh setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="mesh.html#checklist-for-after-you-change-the-mesh">Checklist for after you change the mesh</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="utilities.html">Utilities and Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="utilities.html#gis-conversion">GIS Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="utilities.html#hotstart-inventory-convert-iteration-numbers-to-dates">Hotstart Inventory: Convert iteration numbers to dates</a></li>
<li class="toctree-l4"><a class="reference internal" href="utilities.html#model-time-and-multi-clip">model_time and multi_clip</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../calibration.html">Calibration Report and References</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../calibration.html#calibration">Calibration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help.html#support">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../refs.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bay-Delta SCHISM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!-- Empty override file take the place of env/lib/python3.8/site-packages/sphinx_rtd_theme/breadcrumbs.html, which generates the top nav breadcrumbs. -->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="test-suite-for-prechecking-runs">
<h1>Test Suite for Prechecking Runs<a class="headerlink" href="#test-suite-for-prechecking-runs" title="Link to this heading"></a></h1>
<section id="using-the-tests">
<h2>Using the Tests<a class="headerlink" href="#using-the-tests" title="Link to this heading"></a></h2>
<p>Bay-Delta SCHISM is a complex application and many setup issues recur. The project contains a pre-check suite
for finding some of these repeat errors. Some tests SCHISM input consistency in general, many others
invoke Bay-Delta domain-specific relationships.</p>
<p>The suite is contained in the <cite>test_suite</cite> directory of Bay-Delta SCHISM. The testing system is based on pytest, the ubiquitous testing
framework for Python. For those who are unfamiliar, pytest takes care of launching tests, counting successes and failures and tracking
simulation information as <em>fixtures</em>. Some of this is lingo. See the <a class="reference external" href="https://docs.pytest.org/">pytest web site</a></p>
<p>To run the tests you will first of all need to make sure your environment has pytest in it. Remember, you are not just adding this to
your developer environment to test code, but to launch it as a user in everyday modeling. The
<a class="reference external" href="https://github.com/CADWRDeltaModeling/BayDeltaSCHISM/blob/master/schism_env.yml">recommended environment</a> has pytest in it.</p>
<p>Then you use a command like the following:</p>
<blockquote>
<div><p>sim_dir$ pytest /path/to/BayDeltaSCHISM/test_suite –sim_dir=.</p>
</div></blockquote>
<p>Note that the <cite>–sim_dir=.</cite> part of the command is actually the default, so you can omit this if you launch the testing framework in the study directory
you are testing. The path <cite>/path/to/BayDeltaSCHISM/test_suite</cite> is a pointer to your Bay-Delta SCHISM installation subdirectory.</p>
<p>To make it simpler, we recommend setting an alias on the command line or in your .bashrc file:</p>
<blockquote>
<div><p>alias schism_pretest=’pytest /path/to/BayDeltaSCHISM/test_suite’</p>
</div></blockquote>
</section>
<section id="writing-run-tests">
<h2>Writing Run Tests<a class="headerlink" href="#writing-run-tests" title="Link to this heading"></a></h2>
<section id="basics-of-testing">
<h3>Basics of testing<a class="headerlink" href="#basics-of-testing" title="Link to this heading"></a></h3>
<p>Leaving aside some quibbles over conventions, a test is just a function that has a name that starts
with <cite>test_</cite> and that contains a python assert statement that contains the items to be tested and a message for failure:</p>
<blockquote>
<div><dl class="simple">
<dt>def test_silly():</dt><dd><p>assert 1 == 2, “One is not equal to two”</p>
</dd>
</dl>
</div></blockquote>
<p>Bay-Delta SCHISM run tests are housed in the <cite>/test_suite</cite> directory of your Bay-Delta SCHISM installation.
Any test scripts in this directory will be run when you launch pytest with the <cite>/test_suite</cite> directory.
They are usually launched in the simulation directory or you can name the simulation directory in your pytest command as
in the introductory example.</p>
</section>
<section id="test-fixtures">
<h3>Test Fixtures<a class="headerlink" href="#test-fixtures" title="Link to this heading"></a></h3>
<p>You will need to know the concepts of a <em>test fixture</em>, if only to make use of a small number of super important
fixtures that are already defined. You can read about test fixtures on the <a class="reference external" href="https://docs.pytest.org/">pytest web site</a></p>
<p>First, there is the <cite>sim_dir</cite> fixture. Please use this rather than writing tests that assume
the test is run in the simulation directory.
A trivial example that uses <cite>sim_dir</cite> looks like this:</p>
<dl class="simple">
<dt>def test_param_exists(sim_dir):</dt><dd><p>assert os.path.exists(os.path.join(sim_dir,”param.nml”)), “Simulation directory must contain ‘param.nml’”</p>
</dd>
</dl>
<p>Where <cite>sim_dir</cite> is applied as an input to he test_param_exists function.
This calls the <cite>sim_dir</cite> fixture function found in conftest.py and then submits the output of that function to the test_param_exists function.
A second indispensible fixture is <cite>params</cite>. This fetches the run parameters in <cite>param.nml</cite> using the <cite>param.py</cite> module.
You should avoid parse <cite>param.nml</cite> with your own code.</p>
<p>A third proposal allows run-specific variables in a testconfig.yaml file that is in <cite>sim_dir</cite>.</p>
</section>
<section id="markers">
<h3>Markers<a class="headerlink" href="#markers" title="Link to this heading"></a></h3>
<p>You can learn about markers on the <a class="reference external" href="https://docs.pytest.org/">pytest web site</a>. You can use them to categorize tests.
Please use the <cite>prerun</cite> marker:</p>
<blockquote>
<div><p>&#64;pytest.mark.prerun
def test_something():</p>
<blockquote>
<div><p>assert 1==2, “Failure message”</p>
</div></blockquote>
</div></blockquote>
<p>The marker will be ran upon calling pytest and any assert statement that fails (ex: 1==2) will trigger the following ‘Failure message’.
That’s where you can add helpful information about what the test failure is and how to fix it.</p>
</section>
<section id="what-to-test">
<h3>What to test<a class="headerlink" href="#what-to-test" title="Link to this heading"></a></h3>
<p>Start with what is broken or what perenially gets out of synch. The Bay-Delta SCHISM testing suite has the feel of being <em>regression tests</em>.
Regression tests are basically checking for things that have gone wrong before. Examples:</p>
<ul class="simple">
<li><p>Source and sink (channel depletion) time series have different numbers of columns than the number of sources and sinks declared in <cite>source_sink.in</cite>. This is a generic SCHISM issue. This would be housed in <a class="reference external" href="https://github.com/CADWRDeltaModeling/BayDeltaSCHISM/blob/master/test_suite/test_source_sink.py">test_source_sink.py</a></p></li>
<li><dl class="simple">
<dt>Suisun marsh radial gate, flashboard and boatlock structures are operated in nonsense ways. For instance:</dt><dd><p>the radial gates (montezuma_radial) are operated tidally while the flashboards (montezuma_flashboards) are out. This is an example of domain-specific insight. One of the issues of course is that run checks may slow down users in developing strong knowledge of the region.</p>
</dd>
</dl>
</li>
<li><p>Legacy files such as param.nml or flow_xsects.yaml are used in runs without reviewing them for and out-of-date entries.</p></li>
<li><p>elev2D.th.nc start date matches param.nml start date, see <a class="reference external" href="https://github.com/CADWRDeltaModeling/BayDeltaSCHISM/blob/master/test_suite/test_elev2d.py">test_elev2d.py</a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="checklists.html" class="btn btn-neutral float-left" title="Checklists" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="problems.html" class="btn btn-neutral float-right" title="Common Problems and Diagnosis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014,2020 California Department of Water Resources.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: white;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #86989B; /* existing theme was AFC1C4 and 86989B and CA7900 and white */
      
    }
  </style>


</body>
</html>